= Редактирование расширенных метаданных

Редактировать расширенные метаданные могут только администраторы {dv}.

При использовании расширенных метаданных необходимо учитывать, что элементы управления могут быть привязаны к полям определённых типов. Без привязки в элементах не будут сохраняться значения.

.Требуемые настройки некоторых типовых элементов
[options="header"]
|===
|Элемент управления |Тип секции |Тип поля |Ссылка

|Сотрудник
|Struct
|RefID
a|menu:Базовые карточки[Справочник сотрудников > Подразделения > Сотрудники]

|Сотрудники
|Table
|RefID
a|menu:Базовые карточки[Справочник сотрудников > Подразделения > Сотрудники]

|Строка конструктора справочников
|Struct
|RefID
a|menu:Базовые карточки[Конструктор справочников > Типы записей > Запись]
|===

Если расширенное поле используется в поисковом запросе, представлении или каком-либо другом компоненте системы и было удалено, корректная работа соответствующих компонентов будет нарушена.

.Чтобы изменить расширенное поле:
. Откройте окно редактирования расширенных метаданных любым доступным способом:
+
* Нажмите на кнопку image:buttons/edit-metadata.png[Редактирование метаданных] *Редактирование динамических метаданных* на ленте главного окна xref:layouts/designer.adoc["Конструктора разметок"].
* Нажмите на кнопку в малой форме свойств элемента управления.
* Воспользуйтесь меню выбора источника данных в окне расширенных свойств элемента управления.
+
Окно редактирования расширенных метаданных содержит дерево стандартных ("обычных") метаданных -- элементов схем карточек. Элементы представляют собой иерархию секций и полей, на основе которых создаются стандартные карточки.
+
.Окно редактирования расширенных метаданных
image::edit-extended-metadata.png[Окно редактирования расширенных метаданных]
+
. Нажмите на панели инструментов на кнопку image:buttons/unlocked-blue-fill.png[Синий замок открыт], чтобы заблокировать метаданные для редактирования. Значок блокировки изменится на image:buttons/locked-green-contour.png[Зелёный замок], панель инструментов будет разблокирована.
+
Если метаданные заблокированы другим пользователем, вместо кнопки image:buttons/unlocked-blue-fill.png[Синий замок открыт] будет отображаться значок image:buttons/locked-red-contour.png[Красный замок]. Дождитесь завершения редактирования метаданных другим пользователем -- наведите курсор мыши на значок image:buttons/locked-red-contour.png[Красный замок], чтобы узнать ФИО пользователя, заблокировавшего метаданные.
+
Блокировка автоматически снимается при закрытии Конструктора разметок (с сохранением настроек или без сохранения).
+
. Создайте собственные ветки секций, добавьте в созданные секции пользовательские поля.
. Сохраните изменения.
. Перезапустите сервисы и клиенты {dv}.
+
После добавления или изменения расширенных или динамических метаданных необходимо очистить кэш клиентских и серверных процессов {dv}. Для этого перезапустите все экземпляры сервера {dv} (*{sss}*, IIS, включая экземпляры данных процессов на узлах кластера {dv}), *{wfs}* (включая экземпляры сервиса Workflow на узлах кластера Workflow), экземпляры {wincl}а, все экземпляры сервера {wc} и т. д.

== Добавление секции

[WARNING]
====
Пользовательская секция может быть создана только как секция верхнего уровня. Не рекомендуется добавлять расширенные секции в обычные секции.
====

.Чтобы добавить секцию:
. xref:layouts/edit-extended-metadata.adoc[Откройте] окно _Редактирование метаданных_.
. Для добавления секции, нажмите кнопку image:buttons/plus-green-thin.png[Тонкий зелёный плюс].
+
.Добавление динамической секции
image::dynamic-section.png[Добавление динамической секции]
+
. Заполните поля окна:
+
.. В поле _Имя_ укажите произвольное текстовое обозначение элемента.
.. В поле _Тип_ выберите тип секции:
+
* *_Struct_* -- секции данного типа предназначены для хранения одной строки данных -- одного набора значений полей секции.
+
.Схема плоской секции
image::struct-section-diagram.png[Схема плоской секции]
+
* *_Table_* -- секции данного типа могут использоваться для хранения одной или нескольких не связанных строк данных (наборов значений полей секции).
+
.Схема табличной секции
image::table-section.png[Схема табличной секции]
+
* *_Tree_* -- секции данного типа могут использоваться для хранения одной или нескольких строк данных, которые могут быть связаны между собой по правилу родитель-потомок. Не стоит путать данный тип секций со структурой, включающей родительскую и вложенную секции -- у секции типа *_Tree_* все строки имеют идентичный набор полей.
+
.Иерархическая секция
image::tree-section.png[Иерархическая секция]
+
[WARNING]
====
Запрещено изменять тип существующей расширенной секции.
====
+
. Для секции может быть создано произвольное количество значений имени для разных локалей.
+
С помощью кнопок image:buttons/plus-green.png[Плюс] *Добавить* и image:buttons/x-red.png[Красный крестик] *Удалить* можно добавлять и удалять поля значений. Каждому значению можно назначить любую из доступных в системе локалей (локали обозначаются двух- или трёхбуквенным кодом и доступны в выпадающем списке).

== Добавить, изменить или удалить поле

Поле может быть добавлено только к расширенной секции.

.Условия использования расширенных метаданных:
* Чтобы минимизировать риск возникновения конфликтов с имеющимися расширенными полями, для добавления пользовательских полей _рекомендуется_ использовать пользовательские секции. При этом никаких запретов на добавление расширенных полей в статические секции нет.
* Системные секции нельзя использовать для добавления пользовательских полей. Системная секция предназначена для хранения системной информации о карточке. В каждой карточке такая секция имеет своё название, например, секция _Системные свойства_ (`SystemInfo`).
* Изменение расширенных полей и секций будет приводить к изменениям в схеме таблиц и обновлению хранимых процедур. Такие операции могут блокировать другие транзакции и значительно влиять на время выполнения пользовательских операций. Поэтому изменения в расширенных метаданных стоит выполнять в нерабочее время.
* Для корректной работы с видами, в которых были выполнены операции над расширенными полями, необходимо перезапустить сервисы {dv}.

.Чтобы добавить поле:
. xref:layouts/edit-extended-metadata.adoc[Откройте] окно _Редактирование метаданных_.
. Выберите секцию, в которую требуется добавить поле.
. Нажмите кнопку image:buttons/plus-green-thin.png[Зелёный плюс].
+
Кнопка активна, если в дереве выделена любая секция.
+
.Редактирование динамического поля
image::edit-dynamic-field.png[Редактирование динамического поля]
+
. В поле _Имя_ укажите произвольное текстовое обозначение элемента.
+
В качестве имён нельзя использовать служебные обозначения: _UserID_, _SessionID_, _InstanceID_, _RowID_, _ParentRowID_, _ParentTreeRowID_, _ChangeServerID_, _SDID_ и прочие.
+
[NOTE]
====
Длина имени поля не должна превышать 20 символов.

Использовать кириллицу в названии расширенных полей не рекомендуется для БД Microsoft SQL и запрещено для БД PostgreSQL.
====
+
. В поле _Тип_ выберите один из доступных вариантов, приведенных в таблице.
+
.Доступные варианты типов полей
[cols=",",options="header"]
|===
|Обозначение типа |Значение

|Int |Целое

|Bool |Логический тип (возможны значения true/false)
|DateTime |Дата/время
|Enum |Перечисление
|Bitmask |Битовая маска
|UniqueID |Уникальный идентификатор
|UserID |Идентификатор пользователя
|String |Короткая текстовая строка
|UniString |Строка в формате Unicode
|FileID |Идентификатор файла
|Float |Значение с плавающей точкой
|RefID |Ссылка на значение из справочника или на сам справочник
|RefCardID |Ссылка на карточку
|Text |Текст
|Unitext |Универсальный текст
|Binary |Значение в двоичном виде
|Image |Изображение
|Decimal |Десятичное значение
|Variant |Универсальное поле
|===
+
****
Для полей с текстовым содержимым рекомендуется выбирать типы *_Text_* и *_Unitext_*, для которых в БД отсутствует явное ограничение по размеру содержимого -- в Microsoft SQL представлены типами `varchar(max)` и `nvarchar(max)` соответственно. В отличие от типов *_String_* и *_Unistring_*, для которых установлено ограничение на размер содержимого -- `varchar(8000)` и `nvarchar(8000)` соответственно.

Также следует обратить внимание, что при изменении типа существующего поля с *_String_* на *_Unistring_*, или с *_Unistring_* на *_String_* для них сохраняется установленное при создании ограничение на размер содержимого: для *_String_* -- `4000` знаков, для *_Unistring_* -- `8000` знаков. Фактическое ограничение размера поля смотрите в таблице `dvsys_fielddefs` базы данных {dv}.

Значение поля типа *_Decimal_* в пользовательском интерфейсе отображается с разделителем, установленным в региональных настройках. При изменении значения поля также необходимо использовать десятичный разделитель, установленный в региональных настройках.

[WARNING]
====
Не рекомендуется изменять тип *существующего* расширенного поля. Если новый тип несовместим с текущим, то изменение типов приведет к ошибке.
====
****
+
. В поле _Ссылка_ укажите значение для ссылки.
+
Поле доступно, если для типа ссылки указано значение *_RefID_* или *_RefCardID_*.
+
. В поле _Тип ссылки_ укажите значение типа ссылки.
+
Поле доступно только для типа *_RefCardID_*.
+
.Доступные варианты:
* *_Не указан_*.
* *_Слабая ссылка_*.
* *_Сильная ссылка_*.
* *_Авто_* (тип определяется автоматически).
+
. В поле _Перечисление_ укажите возможные значения поля.
+
Поле доступно только для типа *_Enum_*.
+
.. Нажмите кнопку image:buttons/three-dots.png[Три точки].
.. В появившемся окне _Редактирование энумератора_ добавьте элементы перечисления.
+
Элемент перечисления состоит из псевдонима и значения перечисления -- будет содержаться в поле карточки.
+
.Пример заполнения энумератора
image::fill-enum.png[Пример заполнения энумератора]
+
Длина псевдонима должна быть не больше 64 символов.
+
Для элементов можно настроить отображаемые в карточке значения, иначе отображается псевдоним. Для этого нажмите кнопку image:buttons/pencil-green.png[Карандаш] и добавьте локализованные значения для требуемых языков.
+
.Пример заполнения отображаемых значений элемента энумератора
image::enum-locale.png[Пример заполнения отображаемых значений элемента энумератора]
+
. В поле _При копировании_ выберите способ переноса значения поля карточки, который будет применяться при копировании карточки и создании карточки по шаблону.
+
Поле доступно только для БД {dv}, работающей с *расширенными* метаданными.
+
.Доступные варианты:
* *_Копировать значение поля_* (поведение по умолчанию) -- при копировании или создании по шаблону карточки значение поля будет копироваться.
* *_Очищать значение поля_* -- при копировании или создании по шаблону карточки значение поля будет очищаться (устанавливаться в `NULL`).
* *_Копировать объект по ссылке_* -- при копировании или создании по шаблону карточки будет копироваться связанная карточка или файл. Данный вариант доступен только для полей типа *_RefCardID_* и *_FileID_*.
+
. Завершите настройку нажатием на кнопку *ОК*.
+
В дальнейшем, любое созданное поле или секцию можно отредактировать с помощью кнопок *Редактировать поле* и *Редактировать секцию* на ленте окна редактирования метаданных, либо удалить, нажав кнопку *Удалить поле* или *Удалить секцию*. Эти команды также доступны в контекстном меню поля или секции.

[#loading]
include::partial$update-metadata.adoc[]
